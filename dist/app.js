!function(e){var t={};function n(s){if(t[s])return t[s].exports;var o=t[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(s,o,function(t){return e[t]}.bind(null,o));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=24)}([function(e,t){e.exports=require("@opentelemetry/api")},function(e,t){e.exports=require("shortid")},function(e,t){e.exports=require("countly-sdk-nodejs")},function(e,t){e.exports=require("@slack/web-api")},function(e,t){e.exports=require("lodash/isObject")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("util")},function(e,t){e.exports=require("@opentelemetry/tracing")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("lodash/map")},function(e,t){e.exports=require("@opentelemetry/exporter-jaeger")},function(e,t){e.exports=require("sqlite3")},function(e,t){e.exports=require("sqlite")},function(e,t){e.exports=require("redis")},function(e,t){e.exports=require("express-handlebars")},function(e,t){e.exports=require("async_hooks")},function(e,t){e.exports=require("lodash/isString")},function(e,t){e.exports=require("lodash/uniqBy")},function(e,t){e.exports=require("lodash/chunk")},function(e,t){e.exports=require("lodash/groupBy")},function(e,t){e.exports=require("lodash/isEmpty")},function(e,t){e.exports=require("lodash/uniq")},function(e,t){e.exports=require("lodash/find")},function(e,t){e.exports=require("dotenv")},function(e,t,n){"use strict";n.r(t);var s={};n.r(s),n.d(s,"info",(function(){return c})),n.d(s,"warn",(function(){return l})),n.d(s,"error",(function(){return u}));var o=n(7),r=n(10),i=n(4),a=n.n(i);function c(e,...t){t[0]=`${(new Date).toISOString()} - [info] ${e}`,t.forEach((e,n)=>{a()(e)&&(t[n]=JSON.stringify(e))}),console.log(...t)}function l(e,...t){t[0]=`${(new Date).toISOString()} - [warn] ${e}`,t.forEach((e,n)=>{a()(e)&&(t[n]=JSON.stringify(e))}),console.warn(...t)}function u(e,...t){t[0]=`${(new Date).toISOString()} - [error] ${e}`,t.forEach((e,n)=>{a()(e)&&(t[n]=JSON.stringify(e))}),console.error(...t)}var d=n(11),p=n(12),f=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let v;function m(){return v}var _=n(13),h=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let y;function g(){return y}var I=n(2),S=n.n(I),b=n(5),P=n(8),$=n(14),A=n(3),N=n(15),x=n(0);const T=new N.AsyncLocalStorage;function O(e={}){return(t,n,s)=>{const o=s.value,r=e.name||`${t.name}.${n}`;return s.value=function(...e){const t=x.trace.getTracer("default"),n=T.getStore(),s={};n&&(s.parent=n.span);const i=t.startSpan(r,s);try{const t=T.run({span:i},()=>o.apply(this,e));return"object"==typeof t&&t.then&&t.catch?t.then(e=>(i.end(),e)).catch(e=>{throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:x.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}):(i.end(),t)}catch(e){throw i.addEvent("error",{event:"error",message:e.message,stack:e.stack,"error.kind":e.name}),i.setStatus({code:x.CanonicalCode.UNKNOWN,message:e.message}),i.end(),e}},s}}function E(){const e=T.getStore();return null==e?void 0:e.span}var C,w=function(e,t,n,s){var o,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(r<3?o(i):r>3?o(t,n,i):o(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},k=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};!function(e){e.PARTICIPANTS="participants",e.POINTS="points",e.PROTECTED="proctected"}(C||(C={}));let j=(()=>{class e{static findById(e){return k(this,void 0,void 0,(function*(){const t=E();null==t||t.setAttribute("id",e);return m().get("SELECT * FROM team WHERE id = ?",e)}))}static create({id:e,name:t,access_token:n,scope:s,user_id:o}){return k(this,void 0,void 0,(function*(){const r=E();null==r||r.setAttributes({id:e,name:t,scope:s,user_id:o});const i=m();yield i.run("INSERT INTO\n          team (id, name, access_token, scope, user_id)\n        VALUES\n          ($id, $name, $access_token, $scope, $user_id)",{$id:e,$name:t,$access_token:n,$scope:s,$user_id:o})}))}static update({id:e,name:t,access_token:n,scope:s,user_id:o}){return k(this,void 0,void 0,(function*(){const r=E();null==r||r.setAttributes({id:e,name:t,scope:s,user_id:o});const i=m();yield i.run("UPDATE\n        team\n      SET\n        name = $name,\n        access_token = $access_token,\n        scope = $scope,\n        user_id = $user_id\n      WHERE\n        id = $id",{$id:e,$name:t,$access_token:n,$scope:s,$user_id:o})}))}static upsert({id:t,name:n,access_token:s,scope:o,user_id:r}){return k(this,void 0,void 0,(function*(){const i=E();null==i||i.setAttributes({id:t,name:n,scope:o,user_id:r});return(yield e.findById(t))?yield e.update({id:t,name:n,access_token:s,scope:o,user_id:r}):yield e.create({id:t,name:n,access_token:s,scope:o,user_id:r}),e.findById(t)}))}static fetchSettings(e,t){return k(this,void 0,void 0,(function*(){const n=E();null==n||n.setAttributes({teamId:e,channelId:t});const s=m(),o=yield s.all("SELECT\n        setting_key,\n        setting_value\n      FROM\n        channel_settings\n      WHERE\n        team_id = $teamId AND\n        channel_id = $channelId;",{$teamId:e,$channelId:t}),r={};return o.forEach(e=>{r[e.setting_key]=e.setting_value}),r}))}static upsertSettings(t,n,s){return k(this,void 0,void 0,(function*(){const o=Object.keys(s).map(o=>e.upsertSetting(t,n,o,s[o]));yield Promise.all(o)}))}static upsertSetting(e,t,n,s){return k(this,void 0,void 0,(function*(){const o=E();null==o||o.setAttributes({teamId:e,channelId:t,key:n,value:s});const r=m();yield r.run("INSERT INTO\n        channel_settings (team_id, channel_id, setting_key, setting_value)\n      VALUES (\n        $teamId,\n        $channelId,\n        $settingKey,\n        $settingValue\n      )\n      ON CONFLICT(team_id, channel_id, setting_key)\n      DO UPDATE SET setting_value = $settingValue;",{$teamId:e,$channelId:t,$settingKey:n,$settingValue:s})}))}static updateCustomPoints(e,t){return k(this,void 0,void 0,(function*(){const n=m(),s=t.match(/\S+/g)||[];(t=s.join(" "))||(t=null),yield n.run("UPDATE\n        team\n      SET\n        custom_points = $customPoints\n      WHERE\n        id = $id",{$id:e,$customPoints:t})}))}}return w([O()],e,"findById",null),w([O()],e,"create",null),w([O()],e,"update",null),w([O()],e,"upsert",null),w([O()],e,"fetchSettings",null),w([O()],e,"upsertSettings",null),w([O()],e,"upsertSetting",null),e})();var L=n(1),R=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};function U(e){return R(this,void 0,void 0,(function*(){try{return[void 0,yield e]}catch(e){return[e,void 0]}}))}var K=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};class M{static handle(e,t){return K(this,void 0,void 0,(function*(){if(e.query.error)return u("Could not oauth, req.query.error: "+e.query.error),t.status(500).send(e.query.error);if(e.query.code){const n=new A.WebClient,[s,o]=yield U(n.oauth.v2.access({client_id:process.env.SLACK_CLIENT_ID,client_secret:process.env.SLACK_CLIENT_SECRET,code:e.query.code}));if(s){const e=Object(L.generate)();return u(`(${e}) Could not oauth, slack api call failed`,s),t.status(500).send(`Internal server error, please try again (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}const[r,i]=yield U(j.upsert({id:o.team.id,name:o.team.name,access_token:o.access_token,scope:o.scope,user_id:o.authed_user.id}));if(r){const e=Object(L.generate)();u(`(${e}) Could not oauth, sqlite upsert failed - ${r.message}`,r),t.status(500).send(`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}return process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"added_to_team",count:1,segmentation:{}}),c(`Added to team "${i.name}"(${i.id}) by ${i.user_id}`),t.render("oauth-success",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,TEAM_NAME:i.name}})}const n=Object(L.generate)();return u(`(${n}) Could not oauth, unknown error`,e.query),t.status(500).send(`Unknown error (error code: ${n})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`)}))}}var D=n(16),Y=n.n(D);function q(e,t){const n=[];let s;if(t.global)for(;s=t.exec(e);)n.push(s[1]);else(s=t.exec(e))&&n.push(s[1]);return n}var V=n(6),B=function(e,t,n,s){var o,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(r<3?o(i):r>3?o(t,n,i):o(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},J=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let W=(()=>{class e{static findById(e){return J(this,void 0,void 0,(function*(){const t=E();null==t||t.setAttribute("id",e);const n=g(),s=Object(V.promisify)(n.get.bind(n)),o=yield s(H(e));if(o)return JSON.parse(o)}))}static upsert(e){return J(this,void 0,void 0,(function*(){const t=E();null==t||t.setAttribute("id",e.id);const n=g(),s=Object(V.promisify)(n.set.bind(n));yield s(H(e.id),JSON.stringify(e),"EX",Number(process.env.SESSION_TTL))}))}static delete(e){return J(this,void 0,void 0,(function*(){const t=E();null==t||t.setAttribute("id",e);const n=g(),s=Object(V.promisify)(n.del.bind(n));yield s(H(e))}))}}return B([O()],e,"findById",null),B([O()],e,"upsert",null),B([O()],e,"delete",null),e})();function H(e){return`${process.env.REDIS_NAMESPACE}:session:${e}`}var G=n(17),F=n.n(G),Q=n(18),z=n.n(Q),X=n(9),Z=n.n(X),ee=n(19),te=n.n(ee),ne=function(e,t,n,s){var o,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(r<3?o(i):r>3?o(t,n,i):o(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},se=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};const oe=["0","1/2","1","2","3","5","8","13","20","40","100","∞","?"];var re;!function(e){e.NO_PARTICIPANTS="no_participants",e.TITLE_REQUIRED="title_required",e.INVALID_POINTS="invalid_points",e.SESSION_NOT_ACTIVE="session_not_active",e.ONLY_PARTICIPANTS_CAN_VOTE="only_participants_can_vote"}(re||(re={}));let ie=(()=>{class e{static postMessage(e,t){return se(this,void 0,void 0,(function*(){const n=new A.WebClient(t.access_token),s=Z()(e.participants.sort(),e=>`<@${e}>: awaiting`).join("\n");return n.chat.postMessage({channel:e.channelId,text:`Title: *${e.title}*\n\nVotes:\n${s}`,attachments:ae(e)})}))}static openModal({triggerId:e,team:t,channelId:n,title:s,participants:o,points:r,isProtected:i}){return se(this,void 0,void 0,(function*(){const a=new A.WebClient(t.access_token),c={text:{type:"plain_text",text:"Protected (prevent others to cancel or reveal this session)",emoji:!0},value:"protected"};yield a.views.open({trigger_id:e,view:{callback_id:"newSessionModal:submit",private_metadata:JSON.stringify({channelId:n}),type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},submit:{type:"plain_text",text:"Start New Session",emoji:!0},close:{type:"plain_text",text:"Cancel",emoji:!0},blocks:[{type:"input",block_id:"title",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Write a topic for this voting session",emoji:!0},initial_value:s||""},label:{type:"plain_text",text:"Session Title",emoji:!0}},{type:"input",block_id:"participants",element:{type:"multi_users_select",placeholder:{type:"plain_text",text:"Add users",emoji:!0},initial_users:o},label:{type:"plain_text",text:"Participants",emoji:!0}},{type:"input",block_id:"points",element:{type:"plain_text_input",placeholder:{type:"plain_text",text:"Change poker points",emoji:!0},initial_value:r.join(" ")||oe.join(" ")},hint:{type:"plain_text",text:"Enter points seperated by space",emoji:!0},label:{type:"plain_text",text:"Points",emoji:!0}},{type:"input",block_id:"other",optional:!0,element:{type:"checkboxes",options:[c],initial_options:i?[c]:void 0},label:{type:"plain_text",text:"Other",emoji:!0}}]}})}))}static revealAndUpdateMessage(t,n,s){return se(this,void 0,void 0,(function*(){t.state="revealed",yield e.updateMessage(t,n,s),yield W.delete(t.id)}))}static cancelAndUpdateMessage(t,n,s){return se(this,void 0,void 0,(function*(){t.state="cancelled",yield e.updateMessage(t,n,s),yield W.delete(t.id)}))}static vote(t,n,s,o){return se(this,void 0,void 0,(function*(){if("active"!=t.state)throw new Error(re.SESSION_NOT_ACTIVE);if(-1==t.participants.indexOf(s))throw new Error(re.ONLY_PARTICIPANTS_CAN_VOTE);if(t.votes[s]=o,t.state=Object.keys(t.votes).length==t.participants.length?"revealed":"active","revealed"==t.state)return yield e.updateMessage(t,n),yield W.delete(t.id),void c(`[${n.name}(${n.id})] Auto revealing votes sessionId=${t.id}`);yield W.upsert(t);try{yield e.updateMessage(t,n)}catch(e){l("Could not refreshed session message after a vote, "+e)}}))}static updateMessage(e,t,n){return se(this,void 0,void 0,(function*(){const s=new A.WebClient(t.access_token);if("revealed"==e.state){const t=te()(e.participants,t=>e.votes[t]||"not-voted"),o=Object.keys(t).sort().map(e=>{const n=t[e],s=1==n.length?"1 person":n.length+" people",o=n.sort().map(e=>`<@${e}>`).join(", ");return"not-voted"==e?`${s} *did not voted* (${o})`:`${s} voted *${e}* (${o})`}).join("\n");yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:n?`Title: *${e.title}* (revealed by <@${n}>)\n\nResult:\n${o}`:`Title: *${e.title}*\n\nResult:\n${o}`,attachments:[]})}else if("cancelled"==e.state)yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:n?`Title: *${e.title}* (cancelled by <@${n}>)`:`Title: *${e.title}* (cancelled)`,attachments:[]});else{const t=Z()(e.participants.sort(),t=>e.votes.hasOwnProperty(t)?`<@${t}>: :white_check_mark:`:`<@${t}>: awaiting`).join("\n");yield s.chat.update({ts:e.rawPostMessageResponse.ts,channel:e.rawPostMessageResponse.channel,text:`Title: *${e.title}*\n\nVotes:\n${t}`,attachments:ae(e)})}}))}static exractMentions(e){const t=[];return q(e,/<@(.*?)>/g).forEach(e=>{t.push({type:"user",id:e.split("|")[0]})}),q(e,/<!(.*?)>/g).forEach(e=>{if(["everyone","channel","here"].indexOf(e)>-1)t.push({type:"special",id:e});else if(e.includes("subteam")){const[n,s]=e.replace("subteam^","").split("|");t.push({type:"user-group",id:n})}}),F()(t,e=>`${e.type}-${e.id}`)}static stripMentions(e){return e.replace(/<@(.*?)>/g,"").replace(/<!(.*?)>/g,"").replace(/\s\s+/g," ").trim()}}return ne([O()],e,"postMessage",null),ne([O()],e,"openModal",null),ne([O()],e,"revealAndUpdateMessage",null),ne([O()],e,"cancelAndUpdateMessage",null),ne([O()],e,"vote",null),ne([O()],e,"updateMessage",null),e})();function ae(e){return[...z()(e.points,5).map(t=>({text:"",fallback:"You are unable to vote",callback_id:"vote:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:t.map(e=>({name:"point",text:e,type:"button",value:e}))})),{text:"Actions",fallback:"You are unable to send action",callback_id:"action:"+e.id,color:"#3AA3E3",attachment_type:"default",actions:[{name:"action",text:"Reveal",type:"button",value:"reveal",style:"danger"},{name:"action",text:"Cancel",type:"button",value:"cancel",style:"danger"}]}]}var ce=function(e,t,n,s){var o,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(r<3?o(i):r>3?o(t,n,i):o(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},le=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let ue=(()=>{class e{static handle(t,n){return le(this,void 0,void 0,(function*(){const s=t.body;if(s.token!=process.env.SLACK_VERIFICATION_TOKEN)return u("Could not created session, slack verification token is invalid",s),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});if(!Y()(s.text)){const e=Object(L.generate)();return u(`(${e}) Could not created session, command.text not string`,s),n.json({text:`Unexpected command usage (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}switch(s.text.trim().split(" ")[0]){case"help":return e.help(n);case"config":return yield e.configure(s,n);default:return yield e.openNewSessionModal(s,n)}}))}static openNewSessionModal(e,t){return le(this,void 0,void 0,(function*(){const n=E();if(null==n||n.setAttributes({teamId:e.team_id,teamDomain:e.team_domain,channelId:e.channel_id,channelName:e.channel_name,userId:e.user_id,userName:e.user_name,text:e.text}),"directmessage"==e.channel_name)return t.json({text:"Poker planning cannot be started in direct messages",response_type:"ephemeral",replace_original:!1});const[s,o]=yield U(j.findById(e.team_id));if(s){const o=Object(L.generate)();return u(`(${o}) Could not created session, could not get the team from db`,e,s),null==n||n.setAttribute("error.id",o),null==n||n.setStatus({code:x.CanonicalCode.INTERNAL,message:s.message}),t.json({text:`Internal server error, please try again later (error code: ${o})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!o)return c("Could not created session, team could not be found",e),null==n||n.setStatus({code:x.CanonicalCode.NOT_FOUND,message:"Team not found"}),t.json({text:`Your Slack team (${e.team_domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});if("identify,commands,channels:read,groups:read,users:read,chat:write:bot"==o.scope)return c(`[${o.name}(${o.id})] ${e.user_name}(${e.user_id}) sees migration message`),null==n||n.addEvent("show_migration_message"),t.json({text:`Poker Planner has migrated to <https://slackhq.com/introducing-a-dramatically-upgraded-slack-app-toolkit|Slack's new app toolkit> which adds granular permissions for better security. We now depend on bot permissions instead of user permissions. So that you can explicitly manage which channels/conversations Poker Planner can access. However, this requires a couple of changes:\n\n• In order to obtain new bot permissions and drop user ones, *you need to reinstall Poker Planner* to your workspace on <${process.env.APP_INSTALL_LINK}>\n• Before using \`/pp\` command, *Poker Planner app must be added to that channel/conversation*. You can simply add or invite it by just mentioning the app like \`@poker_planner\`. You can also do that from channel/converstion details menu.`,response_type:"ephemeral",replace_original:!1});try{const[s,r]=yield U(j.fetchSettings(o.id,e.channel_id));s&&(null==n||n.addEvent("settings_fetch_error",{error:s.message}));const i={[C.PARTICIPANTS]:[],[C.POINTS]:oe,[C.PROTECTED]:!1};(null==r?void 0:r[C.PARTICIPANTS])&&(i[C.PARTICIPANTS]=r[C.PARTICIPANTS].split(" ")),o.custom_points&&(i[C.POINTS]=o.custom_points.split(" ")),(null==r?void 0:r[C.POINTS])&&(i[C.POINTS]=r[C.POINTS].split(" ")),(null==r?void 0:r[C.PROTECTED])&&(i[C.PROTECTED]=JSON.parse(r[C.PROTECTED])),yield ie.openModal({triggerId:e.trigger_id,team:o,channelId:e.channel_id,title:ie.stripMentions(e.text).trim(),participants:i[C.PARTICIPANTS],points:i[C.POINTS],isProtected:i[C.PROTECTED]}),t.send(),process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"new_session_modal_opened",count:1,segmentation:{}})}catch(s){const o=Object(L.generate)();return u(`(${o}) Could not open modal`,e,s),null==n||n.setAttribute("error.id",o),null==n||n.setStatus({code:x.CanonicalCode.INTERNAL,message:s.message}),t.json({text:`Could not open modal (error code: ${o})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}))}static configure(e,t){return le(this,void 0,void 0,(function*(){return t.json({text:"This command is depracated. The session settings (points, participants, ...) are now persisted automatically for each channel/conversation.",response_type:"ephemeral",replace_original:!1})}))}static help(e){return e.json({text:"",response_type:"ephemeral",replace_original:!1,attachments:[{color:"#3AA3E3",text:"`/pp`\nOpens a dialog to start a new poker planning session."},{color:"#3AA3E3",text:"`/pp some topic text`\nOpens the same dialog, however title input is automatically filled with the value you provided."}]})}}return ce([O()],e,"openNewSessionModal",null),e})();var de=n(20),pe=n.n(de),fe=n(21),ve=n.n(fe),me=n(22),_e=n.n(me),he=function(e,t,n,s){var o,r=arguments.length,i=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,n):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,n,s);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(i=(r<3?o(i):r>3?o(t,n,i):o(t,n))||i);return r>3&&i&&Object.defineProperty(t,n,i),i},ye=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};let ge=(()=>{class e{static handle(t,n){return ye(this,void 0,void 0,(function*(){let s;try{s=JSON.parse(t.body.payload)}catch(e){const s=Object(L.generate)();return u(`(${s}) Could not parse action payload`,t.body),n.json({text:`Unexpected slack action payload (error code: ${s})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(s.token!=process.env.SLACK_VERIFICATION_TOKEN)return u("Could not process action, invalid verification token",s),n.json({text:"Invalid slack verification token, please get in touch with the maintainer",response_type:"ephemeral",replace_original:!1});switch(s.type){case"interactive_message":return void(yield e.interactiveMessage({payload:s,res:n}));case"view_submission":return void(yield e.viewSubmission({payload:s,res:n}));default:{const e=Object(L.generate)();return u(`(${e}) Unexpected interactive-message action callbackId`,s),n.json({text:`Unexpected payload type (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static interactiveMessage({payload:t,res:n}){return ye(this,void 0,void 0,(function*(){const s=E();null==s||s.setAttributes({callbackId:t.callback_id,teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name,channelId:t.channel.id,channelName:t.channel.name});const o=t.callback_id.split(":");if(2!=o.length){const e=Object(L.generate)();return u(`(${e}) Unexpected interactive message callback id`,t),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected interactive message callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}const[r,i]=o;null==s||s.setAttributes({action:r,sessionId:i});const[a,c]=yield U(W.findById(i));if(a){const e=Object(L.generate)();return u(`(${e}) Could not get session`,t,a),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INTERNAL,message:a.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!c)return null==s||s.setStatus({code:x.CanonicalCode.NOT_FOUND,message:"Session not found"}),n.json({text:"Ooops, could not find the session, it may be expired or cancelled",response_type:"ephemeral",replace_original:!1});const[l,d]=yield U(j.findById(t.team.id));if(l){const e=Object(L.generate)();return u(`(${e}) Could not get team`,t,a),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INTERNAL,message:l.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!d)return null==s||s.setStatus({code:x.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});switch(r){case"action":{const o=t.actions[0].value;if(null==s||s.setAttributes({sessionAction:o}),"reveal"==o)yield e.revealSession({payload:t,team:d,session:c,res:n});else if("cancel"==o)yield e.cancelSession({payload:t,team:d,session:c,res:n});else{const e=Object(L.generate)();u(`(${e}) Unexpected action button clicked: "${o}"`,t),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected session action"}),n.json({text:`Unexpected action button (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return}case"vote":return void(yield e.vote({payload:t,team:d,session:c,res:n}));default:{const e=Object(L.generate)();return u(`(${e}) Unexpected action: "${r}"`),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected action"}),n.json({text:`Unexpected action (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static viewSubmission({payload:t,res:n}){return ye(this,void 0,void 0,(function*(){const s=E();null==s||s.setAttributes({teamId:t.team.id,teamDomain:t.team.domain,userId:t.user.id,userName:t.user.name});const[o,r]=yield U(j.findById(t.team.id));if(o){const e=Object(L.generate)();return u(`(${e}) Could not create session, could not get the team from db`,t,o),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INTERNAL,message:o.message}),n.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}if(!r)return c("Could not create session, team could not be found",t),null==s||s.setStatus({code:x.CanonicalCode.NOT_FOUND,message:"Team not found"}),n.json({text:`Your Slack team (${t.team.domain}) could not be found, please reinstall Poker Planner on <${process.env.APP_INSTALL_LINK}>`,response_type:"ephemeral",replace_original:!1});const i=t.view.callback_id;switch(null==s||s.setAttributes({callbackId:i}),i){case"newSessionModal:submit":return e.createSession({payload:t,team:r,res:n});default:{const e=Object(L.generate)();return u(`(${e}) Unexpected view-submission action callbackId: "${i}"`),null==s||s.setAttribute("error.id",e),null==s||s.setStatus({code:x.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected callback_id"}),n.json({text:`Unexpected view-submission callback id (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}}))}static createSession({payload:e,team:t,res:n}){return ye(this,void 0,void 0,(function*(){const o=E();try{null==o||o.setAttributes({rawPrivateMetadata:e.view.private_metadata});const s=JSON.parse(e.view.private_metadata),r=e.view.state.values.title,i=r[Object.keys(r)[0]].value;if(null==o||o.setAttributes({title:i}),!i||0==i.trim().length)throw new Error(re.TITLE_REQUIRED);const a=e.view.state.values.participants,l=a[Object.keys(a)[0]].selected_users;if(null==o||o.setAttributes({participants:l.join(" ")}),0==l.length)throw new Error(re.NO_PARTICIPANTS);const d=e.view.state.values.points,p=d[Object.keys(d)[0]].value||"";let f=ve()(p.match(/\S+/g))||[];if(null==o||o.setAttributes({points:p}),1==f.length&&"reset"==f[0]&&(f=oe),f.length<2||f.length>25)throw new Error(re.INVALID_POINTS);const v=e.view.state.values.other,m=v[Object.keys(v)[0]].selected_options||[],_=!!_e()(m,e=>"protected"==e.value);null==o||o.setAttributes({isProtected:""+_});const h={id:Object(L.generate)(),title:i,points:f,votes:{},state:"active",channelId:s.channelId,userId:e.user.id,participants:l,rawPostMessageResponse:void 0,protected:_};null==o||o.setAttributes({sessionId:h.id,channelId:s.channelId,userId:e.user.id,userName:e.user.name}),c(`[${t.name}(${t.id})] ${e.user.name}(${e.user.id}) trying to create a session on #${s.channelId} sessionId=${h.id}`);const y=yield ie.postMessage(h,t);h.rawPostMessageResponse=y,yield W.upsert(h),n.send();const[g]=yield U(j.upsertSettings(t.id,h.channelId,{[C.PARTICIPANTS]:h.participants.join(" "),[C.POINTS]:h.points.join(" "),[C.PROTECTED]:JSON.stringify(h.protected)}));g&&(null==o||o.addEvent("upsert_settings_error",{message:g.message}),u("Could not upsert settings after creating new session",h,g)),process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"topic_created",count:1,segmentation:{participants:h.participants.length}})}catch(t){const r=Object(L.generate)();let i=!0,a="error",c=`Internal server error, please try again later (error code: ${r})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,l={};const u=t.data&&t.data.error;return u&&(null==o||o.setAttributes({slackErrorCode:u}),c=`Unexpected Slack API Error: "*${u}*" (error code: ${r})\n\nIf you think this is an issue, please report to <${process.env.ISSUES_LINK}>`),"not_in_channel"==u?(i=!1,c='Poker Planner app is not added to this channel. Please try again after adding it. You can simply add the app just by mentioning it, like "*@poker_planner*".'):"channel_not_found"==u?(a="info",c=`Oops, we couldn't find this channel. Are you sure that Poker Planner app is added to this channel/conversation? You can simply add the app by mentioning it, like "*@poker_planner*". However this may not work in Group DMs, you need to explicitly add it as a member from conversation details menu. Please try again after adding it.\n\nIf you still have a problem, you can open an issue on <${process.env.ISSUES_LINK}> with this error id: `+r):"token_revoked"==u?(a="info",c=`Poker Planner's access has been revoked for this workspace. In order to use it, you need to install the app again on <${process.env.APP_INSTALL_LINK}>`):"method_not_supported_for_channel_type"==u?(a="info",c="Poker Planner cannot be used in this type of conversations."):"missing_scope"==u?"mpim:read"==t.data.needed?(a="info",c=`Poker Planner now supports Group DMs! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):"usergroups:read"==t.data.needed&&(a="info",c=`Poker Planner now supports @usergroup mentions! However it requires additional permissions that we didn't obtained previously. You need to visit <${process.env.APP_INSTALL_LINK}> and reinstall the app to enable this feature.`):t.message==re.NO_PARTICIPANTS?(i=!1,c="You must add at least 1 person.",l={participants:c}):t.message==re.TITLE_REQUIRED?(i=!1,c="Title is required",l={title:c}):t.message==re.INVALID_POINTS&&(i=!1,c="You must provide at least 2 poker points, the maximum is 25.",l={points:c}),i&&s[a](`(${r}) Could not create session`,e,t),null==o||o.setAttributes({"error.id":r,userErrorMessage:c}),null==o||o.setStatus({code:x.CanonicalCode.UNKNOWN,message:t.message}),pe()(l)?n.json({response_action:"push",view:{type:"modal",title:{type:"plain_text",text:"Poker Planner",emoji:!0},close:{type:"plain_text",text:"Close",emoji:!0},blocks:[{type:"section",text:{type:"mrkdwn",text:":x: "+c}}]}}):n.json({response_action:"errors",errors:l})}}))}static vote({payload:e,team:t,session:n,res:s}){return ye(this,void 0,void 0,(function*(){const o=E(),r=e.actions[0].value;null==o||o.setAttributes({point:r}),c(`[${t.name}(${t.id})] ${e.user.name}(${e.user.id}) voting ${r} points sessionId=${n.id}`);const[i]=yield U(ie.vote(n,t,e.user.id,r));if(i)switch(i.message){case re.SESSION_NOT_ACTIVE:return s.json({text:"You cannot vote revealed or cancelled session",response_type:"ephemeral",replace_original:!1});case re.ONLY_PARTICIPANTS_CAN_VOTE:return s.json({text:"You are not a participant of that session",response_type:"ephemeral",replace_original:!1});default:{const e=Object(L.generate)();return u(`(${e}) Could not vote`,i),null==o||o.setAttributes({"error.id":e}),null==o||o.setStatus({code:x.CanonicalCode.INVALID_ARGUMENT,message:"Unexpected vote error"}),s.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}}return process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"topic_voted",count:1,segmentation:{points:e.actions[0].value}}),s.send()}))}static revealSession({payload:e,team:t,session:n,res:s}){return ye(this,void 0,void 0,(function*(){const o=E();if(null==o||o.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return s.json({text:"This session is protected, only the creator can reveal it.",response_type:"ephemeral",replace_original:!1});c(`[${t.name}(${t.id})] ${e.user.name}(${e.user.id}) revealing votes sessionId=${n.id}`);const[r]=yield U(ie.revealAndUpdateMessage(n,t,e.user.id));if(r){const e=Object(L.generate)();return u(`(${e}) Could not reveal session`,r),null==o||o.setAttributes({"error.id":e}),null==o||o.setStatus({code:x.CanonicalCode.INTERNAL,message:"Unexpected error while reveal session & update message"}),s.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"topic_revealed",count:1,segmentation:{}}),s.send()}))}static cancelSession({payload:e,team:t,session:n,res:s}){return ye(this,void 0,void 0,(function*(){const o=E();if(null==o||o.setAttributes({sessionProtected:n.protected,sessionCreatorId:n.userId}),n.protected&&n.userId!=e.user.id)return s.json({text:"This session is protected, only the creator can cancel it.",response_type:"ephemeral",replace_original:!1});c(`[${t.name}(${t.id})] ${e.user.name}(${e.user.id}) cancelling session sessionId=${n.id}`);const[r]=yield U(ie.cancelAndUpdateMessage(n,t,e.user.id));if(r){const e=Object(L.generate)();return u(`(${e}) Could not cancel session`,r),null==o||o.setAttributes({"error.id":e}),null==o||o.setStatus({code:x.CanonicalCode.INTERNAL,message:"Unexpected error while cancel session & update message"}),s.json({text:`Internal server error, please try again later (error code: ${e})\n\nIf this problem is persistent, you can open an issue on <${process.env.ISSUES_LINK}>`,response_type:"ephemeral",replace_original:!1})}return process.env.COUNTLY_APP_KEY&&S.a.add_event({key:"topic_cancelled",count:1,segmentation:{}}),s.send()}))}}return he([O()],e,"interactiveMessage",null),he([O()],e,"viewSubmission",null),he([O()],e,"createSession",null),he([O()],e,"vote",null),he([O()],e,"revealSession",null),he([O()],e,"cancelSession",null),e})();var Ie=function(e,t,n,s){return new(n||(n=Promise))((function(o,r){function i(e){try{c(s.next(e))}catch(e){r(e)}}function a(e){try{c(s.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,a)}c((s=s.apply(e,t||[])).next())}))};n(23).config(),function(){Ie(this,void 0,void 0,(function*(){const e=new o.BasicTracerProvider;if(e.register(),!process.env.REPORT_TRACES)return;const t=new r.JaegerExporter({serviceName:"pp",tags:[],host:process.env.JAEGER_HOST,port:parseInt(process.env.JAEGER_PORT,10),logger:{debug:(...e)=>console.debug("[jaeger-exporter][debug]",...e),info:(...e)=>console.info("[jaeger-exporter][info]",...e),warn:(...e)=>console.warn("[jaeger-exporter][warn]",...e),error:(...e)=>console.error("[jaeger-exporter][error]",...e)}});e.addSpanProcessor(new o.BatchSpanProcessor(t)),c(`Traces will be reported to jaeger-agent on ${process.env.JAEGER_HOST}:${process.env.JAEGER_PORT}`)}))}(),function(){return Ie(this,void 0,void 0,(function*(){yield function(){return f(this,void 0,void 0,(function*(){return v?(l("Trying to init sqlite multiple times!"),v):(c("Opening sqlite..."),v=yield Object(p.open)({filename:process.env.DB_FILE,driver:d.Database}),c("Migrating sqlite..."),yield v.migrate(),v)}))}(),yield function(){return h(this,void 0,void 0,(function*(){return y?(l("Trying to init redis multiple times!"),y):(c("Creating redis client..."),y=_.createClient(),yield new Promise((e,t)=>{y.once("ready",e),y.once("error",t)}),y.on("error",e=>{u("[redis] an error occured",e)}),y)}))}(),yield function(){return Ie(this,void 0,void 0,(function*(){const e=b();return e.engine("html",$({extname:".html"})),e.set("view engine","html"),e.set("views","src/views"),e.use(P.urlencoded({extended:!1})),e.use(P.json()),e.use(process.env.BASE_PATH,b.static("src/public")),function(e){const t=b.Router();t.get("/",(e,t,n)=>{t.render("index",{layout:!1,data:{SLACK_CLIENT_ID:process.env.SLACK_CLIENT_ID,SLACK_SCOPE:process.env.SLACK_SCOPE,SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY}})}),t.get("/privacy",(e,t,n)=>{t.render("privacy",{layout:!1,data:{SLACK_APP_ID:process.env.SLACK_APP_ID,COUNTLY_URL:process.env.COUNTLY_URL,COUNTLY_APP_KEY:process.env.COUNTLY_APP_KEY}})}),t.get("/oauth",M.handle),t.post("/slack/pp-command",ue.handle),t.post("/slack/action-endpoint",ge.handle),t.get("/slack/direct-install",(e,t,n)=>{const s=`https://slack.com/oauth/v2/authorize?client_id=${process.env.SLACK_CLIENT_ID}&scope=${process.env.SLACK_SCOPE}`;t.status(302).redirect(s)}),e.use(""+process.env.BASE_PATH,t)}(e),new Promise((t,n)=>{e.listen(process.env.PORT,e=>{if(e)return n(e);c("Server running on "+process.env.PORT),t()})})}))}(),process.env.COUNTLY_APP_KEY&&process.env.COUNTLY_URL&&(c(`Initing countly - ${process.env.COUNTLY_URL} with app key: ${process.env.COUNTLY_APP_KEY}`),S.a.init({app_key:process.env.COUNTLY_APP_KEY,url:process.env.COUNTLY_URL})),c("Boot successful!")}))}().catch(e=>{u("Could not boot",e),process.exit(1)})}]);
//# sourceMappingURL=app.js.map